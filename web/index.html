<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MongoCollectibles - Collectible Rentals</title>
  
  <!-- Alpine.js for reactivity (this makes x-data, x-for, etc. work) -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <style>
    /* =============================================
       SIMPLE CSS - No frameworks, just plain CSS
       ============================================= */
    
    /* Reset default margins/padding */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    /* ---------- NAVIGATION ---------- */
    nav {
      background-color: #1a1a2e;
      color: white;
      padding: 15px 20px;
    }

    nav h1 {
      font-size: 24px;
    }

    /* ---------- HEADER ---------- */
    header {
      background-color: #16213e;
      color: white;
      text-align: center;
      padding: 40px 20px;
    }

    header h2 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    header p {
      color: #ccc;
    }

    /* ---------- MAIN CONTENT ---------- */
    main {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }

    h3 {
      text-align: center;
      margin-bottom: 20px;
    }

    /* ---------- FILTER BUTTONS ---------- */
    .filters {
      text-align: center;
      margin-bottom: 30px;
    }

    .filter-btn {
      background-color: white;
      border: 1px solid #ddd;
      padding: 8px 16px;
      margin: 5px;
      cursor: pointer;
      border-radius: 4px;
    }

    .filter-btn:hover,
    .filter-btn.active {
      background-color: #e94560;
      color: white;
      border-color: #e94560;
    }

    /* ---------- PRODUCT GRID ---------- */
    /* 
     * CSS Grid creates a responsive grid layout
     * repeat(auto-fill, minmax(220px, 1fr)) means:
     *   - Create as many columns as will fit
     *   - Each column is at least 220px wide
     *   - Columns grow to fill available space equally
     */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
    }

    /* ---------- PRODUCT CARD ---------- */
    /* 
     * Each product from the database becomes one of these cards.
     * Alpine.js loops through the products array and creates
     * a new .product-card for each item.
     */
    .product-card {
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .product-card:hover {
      transform: translateY(-5px);
    }

    /* Image container - position:relative lets us position the badge */
    .product-card .image-wrapper {
      position: relative;
    }

    .product-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;  /* Crop image to fit, maintaining aspect ratio */
    }

    /* Size badge positioned in top-right corner */
    .product-card .size-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background-color: #1a1a2e;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    /* Card content below the image */
    .product-card .info {
      padding: 15px;
    }

    .product-card .name {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .product-card .details {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }

    .product-card .price {
      color: #e94560;
      font-weight: bold;
    }

    .product-card .stock {
      color: #888;
    }

    /* ---------- LOADING STATE ---------- */
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    /* ---------- MODAL (POPUP) ---------- */
    /* 
     * The modal appears when you click a product card.
     * It shows product details and a rental calculator form.
     */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      padding: 20px;
    }

    .modal {
      background-color: white;
      border-radius: 8px;
      max-width: 450px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal .image-wrapper {
      position: relative;
    }

    .modal img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }

    .modal .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 4px;
    }

    .modal .content {
      padding: 20px;
    }

    .modal h2 {
      margin-bottom: 10px;
      font-size: 20px;
    }

    .modal .meta {
      color: #666;
      margin-bottom: 15px;
      font-size: 14px;
    }

    /* ---------- FORM ELEMENTS ---------- */
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 13px;
    }

    input, select {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .btn-primary {
      width: 100%;
      background-color: #e94560;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-primary:hover {
      background-color: #d63050;
    }

    .btn-secondary {
      width: 100%;
      background-color: #1a1a2e;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
    }

    /* ---------- QUOTE RESULT BOX ---------- */
    .quote-result {
      background-color: #e8f5e9;
      border: 1px solid #a5d6a7;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
    }

    .quote-result p {
      margin: 5px 0;
      font-size: 14px;
    }

    .quote-result .total {
      font-size: 22px;
      color: #e94560;
      font-weight: bold;
      text-align: right;
      margin-top: 10px;
    }

    .error-box {
      background-color: #ffebee;
      border: 1px solid #ef9a9a;
      color: #c62828;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
    }

    /* ---------- FOOTER ---------- */
    footer {
      background-color: #1a1a2e;
      color: white;
      text-align: center;
      padding: 20px;
      margin-top: 40px;
    }

    /* Hide elements with x-cloak until Alpine.js loads */
    [x-cloak] { display: none !important; }
  </style>
</head>

<!--
  =============================================
  ALPINE.JS BASICS
  =============================================
  
  x-data="catalogueApp()"
    - This tells Alpine to use the catalogueApp() function 
    - All the data (products, stores, etc.) comes from there
    - All the methods (loadProducts, openModal, etc.) come from there
  
  Inside this body, we can use:
    - x-for="item in array"    â†’ Loop through an array
    - x-text="variable"        â†’ Display text from a variable  
    - :src="variable"          â†’ Bind an attribute to a variable
    - @click="function()"      â†’ Call a function when clicked
    - x-show="condition"       â†’ Show/hide based on a condition
-->
<body x-data="catalogueApp()">

  <!-- NAVIGATION BAR -->
  <nav>
    <h1>ðŸŽ­ MongoCollectibles</h1>
  </nav>

  <!-- HEADER SECTION -->
  <header>
    <h2>Rent Premium MCU Collectibles</h2>
    <p>Access rare statues and figurines without the full purchase price.</p>
  </header>

  <!-- MAIN CONTENT -->
  <main>
    <h3>Our Collection</h3>

    <!-- FILTER BUTTONS -->
    <!-- 
      @click="filter = 'all'" â†’ When clicked, set the filter variable to 'all'
      :class="{ active: filter === 'all' }" â†’ Add 'active' class if filter equals 'all'
    -->
    <div class="filters">
      <button class="filter-btn" @click="filter = 'all'" :class="{ active: filter === 'all' }">All</button>
      <button class="filter-btn" @click="filter = 'L'" :class="{ active: filter === 'L' }">Large</button>
      <button class="filter-btn" @click="filter = 'M'" :class="{ active: filter === 'M' }">Medium</button>
      <button class="filter-btn" @click="filter = 'S'" :class="{ active: filter === 'S' }">Small</button>
    </div>

    <!-- LOADING STATE (shows while fetching data) -->
    <div x-show="loading" class="loading">
      <p>Loading products...</p>
    </div>

    <!-- 
      =============================================
      PRODUCT GRID - THIS IS WHERE THE MAGIC HAPPENS!
      =============================================
      
      The products come from the database via the /catalogue API endpoint.
      Alpine.js fetches them and stores them in the 'products' array.
      
      x-for="product in filteredProducts" 
        â†’ This LOOPS through each product in the filteredProducts array
        â†’ For each product, it creates a new product-card div
      
      :key="product.id"
        â†’ Unique identifier for each item (helps Alpine track changes)
      
      Inside the loop, we can access each product's properties:
        - product.id           â†’ The database ID
        - product.name         â†’ "Iron Man Mark 85 Statue"
        - product.size         â†’ "L", "M", or "S"
        - product.imageURL     â†’ URL to the product image
        - product.price_per_day â†’ 10000
        - product.available_units â†’ 5
    -->
    <div x-show="!loading" class="product-grid">
      
      <!-- 
        TEMPLATE TAG: This is a special tag that doesn't render itself.
        It's used by Alpine.js to repeat its contents for each item in the loop.
      -->
      <template x-for="product in filteredProducts" :key="product.id">
        
        <!-- PRODUCT CARD: One card is created for EACH product -->
        <div class="product-card" @click="openModal(product)">
          
          <!-- Image Section -->
          <div class="image-wrapper">
            <!-- 
              :src="product.imageURL" 
                â†’ The colon (:) means "bind this attribute to a variable"
                â†’ Alpine will set src to the actual URL from product.imageURL
              
              onerror="..."
                â†’ Fallback image if the URL fails to load
            -->
            <img :src="product.imageURL" 
                 :alt="product.name"
                 onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
            
            <!-- 
              SIZE BADGE
              x-text="product.size" 
                â†’ Displays the text content of product.size (e.g., "L", "M", "S")
            -->
            <span class="size-badge" x-text="product.size"></span>
          </div>
          
          <!-- Info Section -->
          <div class="info">
            <!-- Product Name -->
            <div class="name" x-text="product.name"></div>
            
            <div class="details">
              <!-- 
                PRICE
                We use two spans here:
                1. Outer span with class "price" for styling
                2. Inner span with x-text to display the formatted number
                
                toLocaleString() adds commas: 10000 â†’ "10,000"
              -->
              <span class="price">
                â‚±<span x-text="product.price_per_day.toLocaleString()"></span>/day
              </span>
              
              <!-- STOCK COUNT -->
              <span class="stock" x-text="product.available_units + ' available'"></span>
            </div>
          </div>
          
        </div>
        
      </template>
      
    </div>

    <!-- EMPTY STATE (shows when no products match filter) -->
    <div x-show="!loading && filteredProducts.length === 0" class="loading">
      <p>No products found for this filter.</p>
    </div>

  </main>

  <!-- 
    =============================================
    MODAL (POPUP) - Shows when a product is clicked
    =============================================
    
    x-show="showModal" â†’ Only visible when showModal is true
    @click.self="showModal = false" â†’ Clicking the dark overlay closes the modal
  -->
  <div x-show="showModal" x-cloak class="modal-overlay" @click.self="showModal = false">
    <div class="modal">
      
      <!-- x-if completely removes/adds the element (vs x-show which just hides it) -->
      <template x-if="selectedProduct">
        <div>
          <!-- Modal Image -->
          <div class="image-wrapper">
            <img :src="selectedProduct.imageURL" :alt="selectedProduct.name">
            <button class="close-btn" @click="showModal = false">âœ•</button>
          </div>
          
          <!-- Modal Content -->
          <div class="content">
            <h2 x-text="selectedProduct.name"></h2>
            <p class="meta">
              <strong>Size:</strong> <span x-text="selectedProduct.size"></span> | 
              <strong>Available:</strong> <span x-text="selectedProduct.available_units"></span> units
            </p>
            
            <hr style="margin: 15px 0;">
            
            <h4 style="margin-bottom: 15px;">Calculate Your Rental</h4>
            
            <!-- RENTAL FORM -->
            <div class="form-row">
              <div>
                <label>Store Location</label>
                <!-- 
                  x-model="rental.storeId" 
                    â†’ Two-way binding: changes to select update rental.storeId
                    â†’ and changes to rental.storeId update the select
                -->
                <select x-model="rental.storeId">
                  <template x-for="store in stores" :key="store.ID">
                    <option :value="store.ID" x-text="store.Name"></option>
                  </template>
                </select>
              </div>
              <div>
                <label>Rental Days</label>
                <input type="number" x-model="rental.days" min="1" max="30">
              </div>
            </div>
            
            <label>Quantity</label>
            <input type="number" x-model="rental.quantity" min="1" :max="selectedProduct.available_units">
            
            <button class="btn-primary" @click="getQuote()" :disabled="quoteLoading">
              <span x-show="!quoteLoading">Get Price Quote</span>
              <span x-show="quoteLoading">Calculating...</span>
            </button>
            
            <!-- QUOTE RESULT (shows after getting a quote) -->
            <div x-show="quote" class="quote-result">
              <p><strong>Unit Price:</strong> â‚±<span x-text="quote?.unit_price?.toLocaleString()"></span></p>
              <p><strong>Quantity:</strong> <span x-text="quote?.quantity"></span> units Ã— <span x-text="quote?.days"></span> days</p>
              <p><strong>Warehouse:</strong> <span x-text="quote?.warehouse"></span></p>
              <div class="total">Total: â‚±<span x-text="quote?.total_price?.toLocaleString()"></span></div>
              
              <button class="btn-secondary" @click="proceedToCheckout()">
                Proceed to Checkout
              </button>
            </div>
            
            <!-- ERROR MESSAGE -->
            <div x-show="quoteError" class="error-box">
              <span x-text="quoteError"></span>
            </div>
            
          </div>
        </div>
      </template>
      
    </div>
  </div>

  <!-- FOOTER -->
  <footer>
    <p>Â© 2026 MongoCollectibles. All rights reserved.</p>
  </footer>

  <!-- 
    =============================================
    JAVASCRIPT - Alpine.js Component Definition
    =============================================
    
    This function returns an object containing:
    1. DATA - variables that store our state (products, stores, etc.)
    2. METHODS - functions that do things (loadProducts, getQuote, etc.)
    3. COMPUTED - properties that derive from other data (filteredProducts)
  -->
  <script>
    function catalogueApp() {
      return {
        // ========================================
        // DATA (State Variables)
        // ========================================
        
        // Array to hold all products from the database
        // After loadProducts() runs, this might look like:
        // [
        //   { id: 1, name: "Iron Man", size: "L", price_per_day: 10000, available_units: 5, imageURL: "..." },
        //   { id: 2, name: "Spider-Man", size: "M", price_per_day: 5000, available_units: 3, imageURL: "..." },
        //   ...
        // ]
        products: [],
        
        // Array to hold all store locations
        stores: [],
        
        // Boolean to show/hide loading indicator
        loading: true,
        
        // Current filter: 'all', 'L', 'M', or 'S'
        filter: 'all',
        
        // Controls whether the modal popup is visible
        showModal: false,
        
        // The product currently being viewed in the modal
        selectedProduct: null,
        
        // Form data for the rental calculator
        rental: {
          storeId: 1,
          days: 7,
          quantity: 1
        },
        
        // Quote data returned from the API
        quote: null,
        quoteLoading: false,
        quoteError: null,

        // ========================================
        // LIFECYCLE (Runs when page loads)
        // ========================================
        
        async init() {
          // This function runs automatically when Alpine initializes
          console.log('App initialized! Fetching data...');
          await this.loadProducts();
          await this.loadStores();
        },

        // ========================================
        // API METHODS
        // ========================================
        
        // Fetch products from the backend /catalogue endpoint
        async loadProducts() {
          this.loading = true;
          
          try {
            // fetch() sends an HTTP GET request to our Go backend
            const response = await fetch('/catalogue');
            
            // Parse the JSON response into a JavaScript array
            this.products = await response.json();
            
            // Check the browser console (F12 â†’ Console tab) to see the data!
            console.log('Products loaded:', this.products);
            
          } catch (error) {
            console.error('Failed to load products:', error);
          }
          
          this.loading = false;
        },

        // Fetch store locations from the backend /stores endpoint
        async loadStores() {
          try {
            const response = await fetch('/stores');
            this.stores = await response.json();
            
            // Set default store to the first one
            if (this.stores.length > 0) {
              this.rental.storeId = this.stores[0].ID;
            }
            
            console.log('Stores loaded:', this.stores);
            
          } catch (error) {
            console.error('Failed to load stores:', error);
          }
        },

        // ========================================
        // COMPUTED PROPERTY
        // ========================================
        
        // This is a "getter" - it runs every time 'filteredProducts' is accessed
        // It automatically re-runs when 'filter' or 'products' changes
        get filteredProducts() {
          // If filter is 'all', return all products
          if (this.filter === 'all') {
            return this.products;
          }
          
          // Otherwise, filter by size
          // .filter() returns a NEW array containing only matching items
          return this.products.filter(product => product.size === this.filter);
        },

        // ========================================
        // ACTION METHODS
        // ========================================
        
        // Opens the modal popup with the selected product
        openModal(product) {
          console.log('Opening modal for:', product.name);
          
          this.selectedProduct = product;  // Store which product was clicked
          this.quote = null;               // Reset previous quote
          this.quoteError = null;          // Reset previous error
          this.rental.quantity = 1;        // Reset quantity
          this.showModal = true;           // Show the modal
        },

        // Gets a price quote from the backend /quote endpoint
        async getQuote() {
          this.quoteLoading = true;
          this.quote = null;
          this.quoteError = null;

          try {
            // Send POST request with rental details
            const response = await fetch('/quote', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                collectible_id: this.selectedProduct.id,
                store_id: parseInt(this.rental.storeId),
                days: parseInt(this.rental.days),
                quantity: parseInt(this.rental.quantity)
              })
            });

            const data = await response.json();
            console.log('Quote response:', data);

            // Check if product is available
            if (data.available === false) {
              this.quoteError = data.message;
            } else {
              this.quote = data;
            }
            
          } catch (error) {
            this.quoteError = 'Failed to get quote. Please try again.';
            console.error('Quote error:', error);
          }

          this.quoteLoading = false;
        },

        // Navigate to checkout page
        proceedToCheckout() {
          // Save order data in browser localStorage
          // The checkout page will read this data
          localStorage.setItem('checkoutData', JSON.stringify({
            product: this.selectedProduct,
            quote: this.quote,
            rental: this.rental
          }));
          
          // Navigate to checkout page
          window.location.href = '/checkout';
        }
      }
    }
  </script>

</body>
</html>
